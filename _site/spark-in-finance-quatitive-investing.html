<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资 | Taotao's Zone</title>
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css" type="text/css" />
  <!-- <link rel="stylesheet" href="/css/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="/css/default.css" type="text/css" />
  <link rel="stylesheet" href="/css/desktop.css" type="text/css" />
  <link rel="stylesheet" href="/css/mobile.css" type="text/css" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
  <script src="/js/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="/js/jquery-migrate-1.2.1.js" type="text/javascript"></script>
  <script src="/js/jquery.transit.min.js" type="text/javascript"></script>
  <script src="/js/common.js" type="text/javascript"></script>
</head>
<body>
  <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
  html {
    background: #333333;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
  }
  /*body { background:transparent;}*/
  @media screen and (max-width: 750px){
    body { background: rgba(255, 255, 255, 0.9); }
  }
</style>

<div id="content" class="post" style="margin-top: 20px;">
  <div id="avatar" class="avatar circle" data-in-right="false" style="width: 150px; height: 150px; position: fixed; top: 40px; z-index: 99; opacity: 0;">
    <div class="center" style="margin-top: 4px; height: 142px; width: 142px; border-radius: 71px; background-image: url('../images/2.jpg');"></div>
  </div>

  <div class="entry" style="position: relative;">
    <h1 class="entry-title"><a href="/spark-in-finance-quatitive-investing" title="『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资">『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资</a></h1>

    <p class="entry-date">2016-03-17 <span class="lastModified" style="display: none;" data-source="_posts/new-spark/2016-03-17-spark-in-finance-quatitive-investing.md">最后更新时间: </span></p>


    <h2 id="section">写在前面</h2>

<p>本系列是综合了自己在学习spark过程中的理解记录 ＋ 对参考文章中的一些理解 ＋ 个人实践spark过程中的一些心得而来。写这样一个系列仅仅是为了梳理个人学习spark的笔记记录，并非为了做什么教程，所以一切以个人理解梳理为主，没有必要的细节就不会记录了。若想深入了解，最好阅读参考文章和官方文档。</p>

<h2 id="section-1">1. 量化投资入门</h2>

<h3 id="section-2">1.1 定义</h3>

<p>量化投资就是借助现代统计学、数学的方法，从海量历史数据中寻找能够带来超额收益的多种“大概率”策略，并纪律严明地按照这些策略所构建的数量化模型来指导投资，力求取得稳定的、可持续的、高于平均的超额回报。量化投资属主动投资范畴，本质是定性投资的数量化实践，理论基础均为市场的非有效性或弱有效性。</p>

<h3 id="section-3">1.2 教程</h3>

<ul>
  <li><a href="https://uqer.io/community/share/569c7068228e5b8ffc744fb3">量化投资视频学习课程</a></li>
  <li><a href="https://uqer.io/community/share/5555b0b4f9f06c6c7104f8a7">开启你的量化之旅！</a></li>
  <li><a href="https://uqer.io/community/share/56749fca228e5bab38c977d1">量化投资门派梳理</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第1天：谁来给我讲讲Python？】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第2天：再接着介绍一下Python呗】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第3天：一大波金融Library来袭之numpy篇】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第4天：一大波金融Library来袭之scipy篇】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第5天：数据处理的瑞士军刀pandas】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第6天：数据处理的瑞士军刀pandas下篇</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第7天：Q Quant 之初出江湖】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第9天 Q Quant兵器谱之二叉树】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第8天 Q Quant兵器谱之函数插值】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第10天 Q Quant兵器谱 -之偏微分方程1】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第11天 Q Quant兵器谱之偏微分方程2】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第12天：量化入门进阶之葵花宝典：因子如何产生和回测】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第13天 Q Quant兵器谱之偏微分方程3】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第14天：如何在优矿上做Alpha对冲模型】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第15天：如何在优矿上搞一个wealthfront出来】</a></li>
  <li><a href="https://uqer.io/community/list/tutorial/all_update/1">量化分析师的Python日记【第16天：如何在优矿上一个人干掉一家公募量化团队！Alpha！Go！】</a></li>
</ul>

<h2 id="section-4">2. 怎么写一个量化策略</h2>

<p>其实，只要认真看完上面的几篇文章，对量化投资，写量化策略就有一个大概的思路了：</p>

<ul>
  <li>获取数据: 数据可是是构建模型的原材料；</li>
  <li>分析数据: 这里有大量的工作需要做，数据清洗，标准化，去极值，中性化等等，这是必要的，因为要让你的量化策略稳健，可解释；</li>
  <li>构建模型: 有了干净的数据，那就可以根据你对数据分析的结果进行模型的构建了；</li>
  <li>构建策略: 把模型的思想转化为一个投资策略；</li>
  <li>策略回测: 把你的投资策略放到过去几年的市场回测，验证，看策略是否如你所想；</li>
  <li>回测归因: 看看你的策略回测是否真实有效；</li>
  <li>策略模拟: 如果你的策略回测表现良好，可以把策略放到实盘中模拟一下，看看现实效果如何；</li>
  <li>策略实盘: 好了，到这里，如果策略模拟盘表现也很好的话，赶紧砸钱根据策略给出的信号进行交易吧，或者直接程序话交易，你每天所需要做的事情就是一件事：躺在床上静静的数钱，哈哈</li>
</ul>

<p>话说了这么多，感觉写一个量化策略好复杂吧，哈哈，其实不然，上面只是一个复杂的量化策略的完整步骤，很多时候也不用这么麻烦，特别是有了 <a href="uqer.io">Uqer</a> 这样高质量，易用，并且完全免费的平台后，写个策略信手拈来。</p>

<p>目前 uqer 上已经有数百个策略了，还有数百个策略研究，上面的大多数策略实现都只用了短短数十行代码，大家可以先看看其中的一些策略：
<a href="https://uqer.io/community/list/new/strategy_update/1">uqer 量化策略列表</a></p>

<p>下面，我们取其中一个策略来做今天的主角：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">### python packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="c">### 策略回测参数</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>         <span class="c"># 回测起始时间</span>
<span class="n">end</span>   <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>         <span class="c"># 回测结束时间</span>
<span class="n">benchmark</span> <span class="o">=</span> <span class="s">'HS300'</span>                  <span class="c"># 策略参考标准</span>
<span class="n">universe</span>  <span class="o">=</span> <span class="n">set_universe</span><span class="p">(</span><span class="s">'HS300'</span><span class="p">)</span>    <span class="c"># 证券池，支持股票和基金</span>
<span class="n">capital_base</span> <span class="o">=</span> <span class="mi">100000</span>                <span class="c"># 起始资金</span>
<span class="n">longest_history</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">refresh_rate</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c"># 调仓频率，表示执行handle_data的时间间隔</span>

<span class="c">### 初始化策略</span>
<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
    <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c">### 策略逻辑，即你的量化投资模型哦，这里用了不到40行代码便轻易实现了一个羊驼策略</span>
<span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
    <span class="n">hist_prices</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_attribute_history</span><span class="p">(</span><span class="s">'closePrice'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="n">yangtuos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">YangTuo</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">valid_secpos</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span><span class="p">))</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">cash</span>

    <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>        
        <span class="n">hist_returns</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">valid_secpos</span><span class="p">:</span>
            <span class="n">hist_returns</span><span class="p">[</span><span class="n">stock</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">sorted_returns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hist_returns</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sell_stock</span> <span class="o">=</span> <span class="n">sorted_returns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cash</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">hist_prices</span><span class="p">[</span><span class="n">sell_stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">account</span><span class="o">.</span><span class="n">valid_secpos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sell_stock</span><span class="p">)</span>
        <span class="n">order_to</span><span class="p">(</span><span class="n">sell_stock</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">yangtuos</span><span class="p">:</span>
        <span class="n">order</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="n">cash</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">yangtuos</span><span class="p">)</span><span class="o">/</span><span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        
<span class="k">class</span> <span class="nc">YangTuo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caoyuan</span><span class="o">=</span><span class="p">[],</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">caoyuan</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">StopIteration</span><span class="p">()</span>        </code></pre></figure>

<p>下面是这个策略的回测表现，很厉害哦</p>

<p><img src="../images/spark-invest-1.jpg" alt="spark-invest-1.jpg" /></p>

<h2 id="spark-">3. spark 在量化投资方面的应用</h2>

<p>好了，上面我们已经介绍了什么是量化投资，量化投资的教程，已经怎么写一个量化投资的策略，还给了一个表现很好的策略哦。接下来，我们就来看看，spark 在量化投资方面的一个简单应用。</p>

<p>首先，我们先指出很多量化策略面临的一个难题，或者是在构建起他很多模型［比如说机器学习，风控模型，动力模型等等］时会遇到的很大的一个问题：<code class="highlighter-rouge">参数调优</code>。</p>

<p>比如说，上面的这个羊驼策略，它的 <em>调仓频率 [refresh_rate], 证券池 [universe], 每次交易的股票数 [YangTuo 这个类的参数] 等等</em>，都有很大的可优化的空间。</p>

<p>每次写策略，我都在想，要是有一天，可以让我指定一个策略的一组参数，然后同时回测这组参数构成的策略，然后最后再来分析哪组参数的策略最具可行性，那就完美了，哈哈。</p>

<p><img src="http://jiangsu.china.com.cn/uploadfile/2015/0709/1436416560465204.jpg" alt="" /></p>

<p>了解spark 后，我才发现，spark 完全可以用来做参数调优啊，甚至在 youtube 的 apache spark 这个 channel 上还有不少大公司用 spark 来做参数调优的分享，看来这个思路是可行的。</p>

<p>那我们就来看看，spark 在金融领域，量化投资方面的应用之：参数调优。</p>

<h3 id="spark--1">3.1 spark 在金融领域，量化投资方面的应用之：参数调优</h3>

<p>首先，为了方面理解，我们这次就针对上面的羊驼策略，调优一个参数：<em>调仓频率 [refresh_rate]</em></p>

<p>下面是利用 spark 来做策略参数调优的完整代码，看见了吗，就算把画图的代码加进去，连100行也不到，oh my g~o~~d, unbelievable!!!!</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#########################</span>
<span class="c"># 策略逻辑</span>
<span class="c">#########################</span>

<span class="c">### packages</span>
<span class="kn">import</span> <span class="nn">quartz</span>
<span class="kn">from</span> <span class="nn">quartz</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">### 策略回测参数</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>            <span class="c"># 回测起始时间</span>
<span class="n">end</span>   <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>            <span class="c"># 回测结束时间</span>
<span class="n">benchmark</span> <span class="o">=</span> <span class="s">'HS300'</span>                        <span class="c"># 策略参考标准</span>
<span class="n">universe</span>  <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">set_universe</span><span class="p">(</span><span class="s">'HS300'</span><span class="p">)</span>
<span class="n">capital_base</span> <span class="o">=</span> <span class="mi">100000</span>   <span class="c"># 起始资金</span>


<span class="c">### 初始化策略</span>
<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
    <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">=</span> <span class="mi">10</span>

    
<span class="c">### 策略逻辑，即你的量化投资模型哦，这里用了不到40行代码便轻易实现了一个羊驼策略</span>
<span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
    <span class="n">hist_prices</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_attribute_history</span><span class="p">(</span><span class="s">'closePrice'</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="n">yangtuos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">YangTuo</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span><span class="p">))</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">cash</span>

    <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>        
        <span class="n">hist_returns</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">valid_secpos</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hist_returns</span><span class="p">[</span><span class="n">stock</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">sorted_returns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hist_returns</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sell_stock</span> <span class="o">=</span> <span class="n">sorted_returns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cash</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">hist_prices</span><span class="p">[</span><span class="n">sell_stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">account</span><span class="o">.</span><span class="n">valid_secpos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sell_stock</span><span class="p">)</span>
        <span class="n">api</span><span class="o">.</span><span class="n">order_to</span><span class="p">(</span><span class="n">sell_stock</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">account</span><span class="o">.</span><span class="n">stocks_num</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">yangtuos</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="n">cash</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">yangtuos</span><span class="p">)</span><span class="o">/</span><span class="n">hist_prices</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        
<span class="k">class</span> <span class="nc">YangTuo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caoyuan</span><span class="o">=</span><span class="p">[],</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span> <span class="o">=</span> <span class="n">caoyuan</span>
        
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caoyuan</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">StopIteration</span><span class="p">()</span>    

<span class="c">### 回测函数，来自 quartz</span>
<span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="n">refresh_rate</span><span class="p">):</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">universe</span><span class="o">=</span><span class="n">universe</span><span class="p">,</span> 
                               <span class="n">capital_base</span><span class="o">=</span><span class="n">capital_base</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">initialize</span><span class="p">,</span> <span class="n">handle_data</span><span class="o">=</span><span class="n">handle_data</span><span class="p">,</span>
                               <span class="n">refresh_rate</span><span class="o">=</span><span class="n">refresh_rate</span><span class="p">)</span>
    <span class="n">perf</span> <span class="o">=</span> <span class="n">quartz</span><span class="o">.</span><span class="n">perf_parse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">refresh_rate</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">perf</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_backtest</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">perf</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">perf_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>
        <span class="n">tmp_name</span> <span class="o">=</span> <span class="s">'parameter_{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
        <span class="n">perf_dataframe</span><span class="p">[</span><span class="n">tmp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">perf_dataframe</span><span class="p">[</span><span class="s">'cumulative_returns'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">perf_dataframe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">tmp_name</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">perf_dataframe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s">'benchmark_cumulative_returns'</span><span class="p">],</span> 
                                     <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">'b.'</span><span class="p">)</span>
            <span class="n">perf_dataframe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">tmp_name</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="s">'white'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span></code></pre></figure>

<p>调优结果展示：</p>

<p><img src="../images/spark-invest-2.jpg" alt="spark-invest-2.jpg" /></p>

<p>ok，这个例子就先讲到这里了，最后打个广告，欢迎大家来 <a href="https://uqer.io/community/list">uqer</a> 来数钱哈，我在 uqer 的链接是：<a href="https://uqer.io/community/user/5480622df9f06c8e773366f4/shares">taotao.li</a>，我们的qq群是：149439636。关于 uqer，有任何问题都可以随时在 uqer 的社区，qq 群联系我啊。</p>

<h2 id="next">2. Next</h2>

<p>既然我们都慢慢开始深入理解 spark 的执行原理了，那下次我们就来说说 spark 的一些配置吧，然后再说说 spark 应用的优化。</p>

<h2 id="section-5">参考文章</h2>

<ul>
  <li><a href="http://www.shenmeshi.com/Business/Business_20100317101449.html">什么是量化投资</a></li>
  <li><a href="http://baike.baidu.com/view/2280811.htm">量化投资</a></li>
</ul>

<h2 id="section-6">本系列文章链接</h2>

<ul>
  <li><a href="../introduction-to-spark">『 Spark 』1. spark 简介 </a></li>
  <li><a href="../spark-questions-concepts">『 Spark 』2. spark 基本概念解析 </a></li>
  <li><a href="../spark-programming-model">『 Spark 』3. spark 编程模式 </a></li>
  <li><a href="../spark-what-is-rdd">『 Spark 』4. spark 之 RDD </a></li>
  <li><a href="../spark-resouces-blogs-paper">『 Spark 』5. 这些年，你不能错过的 spark 学习资源 </a></li>
  <li><a href="../spark-in-finance-quatitive-investing">『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资</a></li>
  <li><a href="deep-into-spark-exection-model">『 Spark 』7. 深入研究 spark 运行原理之 job, stage, task</a></li>
</ul>


    <!-- share icon -->
    <div class="ds-share" data-thread-key="/spark-in-finance-quatitive-investing" data-title="『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资"
         data-content="content"
         data-url="http://litaotao.github.io//spark-in-finance-quatitive-investing">
        <div class="ds-share-aside-left">
          <div class="ds-share-aside-inner">
          </div>
          <div class="ds-share-aside-toggle">分享</div>
        </div>
    </div>

    <div id="disqus_container">
      <div style="margin-bottom:20px">
      <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key=/spark-in-finance-quatitive-investing data-title=『 Spark 』6. 实战案例 ｜ Spark 在金融领域的应用 ｜ 量化投资 data-url=/spark-in-finance-quatitive-investing></div>
      <!-- 多说评论框 end -->
      <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"litaotao"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 end -->
      </div>
    </div>
  </div>

  <div id="menuIndex" class="sidenav">
    <div class="myinfo"><center>
      <div id="avatarHolder" class="avatar circle" style="width: 0px; height: 0px; box-shadow: none; margin-bottom: 20px;"></div>
      <a href="/index.html" title="Homepage"><i class="icon-home icon-large"></i> Home</a>
      <a href="http://www.linkedin.com/in/taotaoli"><i class="icon-linkedin-sign icon-large"></i><span> Profile</span></a>
      <a href="https://github.com/litaotao"><i class="icon-github icon-large"></i><span> Code</span></a>
      <a href="mailto:taotao.engineer@gmail.com"><i class="icon-envelope-alt icon-large"></i><span> Mail</span></a>
    </center></div>
    <div id="menu"></div>
  </div>
</div>


<script src="/js/post.js" type="text/javascript"></script>

</body>
</html>
